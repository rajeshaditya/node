var express = require('express');var router = express.Router();var moment= require('moment');var formidable = require('formidable');var path = require('path');var staffInfo = require('../models/staffinfo');var reviewDate=require('../models/reviewdates');var appraisal = require('../models/appraisal');var fs = require('fs');var current_date=moment().year();/* GET home page. */router.get('/', function(req, res, next) {  res.render('index', { title: 'Express' });});router.get('/login',function(req,res){  res.render('login');});router.get('/reviewdate',function(req,res){res.render('date');});router.post('/getdata',function(req,res){  console.log(JSON.stringify(req.body));  res.send('hai');});function updateEducation(sf,data) {  staffInfo.updateFile(sf,data,function(err){        console.log(err);      });}router.post('/uped',function(req,res){if(req.body.SSC){  var da=JSON.parse(req.body.SSC);  var data={              "SSC.YearOfPass":da.YearOfPass,               "SSC.Institution":da.Institution            };  updateEducation(req.session.user.PinNo,data);}else if(req.body.Inter){  var da=JSON.parse(req.body.Inter);  var data={              "Inter.YearOfPass":da.YearOfPass,               "Inter.Institution":da.Institution            };  updateEducation(req.session.user.PinNo,data);}if(req.body.UG){  var da=JSON.parse(req.body.UG);   var data={              "UG.YearOfPass":da.YearOfPass,               "UG.Institution":da.Institution            }; updateEducation(req.session.user.PinNo,data);}if(req.body.PG){  var da=JSON.parse(req.body.PG);   var data={              "PG.YearOfPass":da.YearOfPass,               "PG.Institution":da.Institution            }; updateEducation(req.session.user.PinNo,data);}});router.get('/edt',function(req,res){res.render('ed');});router.post('/edtd',function(req,res){  console.log(JSON.stringify(req.body));  res.send('hai');});//loginrouter.post('/login',function(req,res){  staffInfo.getUser(req.body.username,req.body.password,function(err,user){    if(!user){      res.render('login', { error: 'Invalid username or password.' });    }     else{        delete user.Password;        req.session.user = user;        res.redirect('/dashbord');      }  });});//LOGOUTrouter.get('/logout', function(req, res){  req.session.reset();  res.redirect('/login');});//dashboard after loginrouter.get('/dashbord',function(req,res){  if(req.session && req.session.user){    res.locals.user = req.session.user;    res.render('dashboard');  }  else{    req.session.reset();    res.redirect('login');  }});// mydatarouter.get('/mydata',function(req,res){  if (req.session && req.session.user){    res.locals.user = req.session.user;    res.render('mydata');  }  else    res.redirect('login');});router.get('/mypolicy',function(req,res){  if (req.session && req.session.user){    res.locals.user = req.session.user;    res.render('mypolicy');  }  else    res.redirect('login');});router.get('/mycampus',function(req,res){  if (req.session && req.session.user){    res.locals.user = req.session.user;    res.render('mycampus');  }  else    res.redirect('login');});router.get('/mycareer',function(req,res){  if (req.session && req.session.user) {    res.locals.user = req.session.user;    if(res.locals.user.DesignationName!='Vice-Chairman'){      reviewDate.getReviewDates(function(err,dates){        if(err)         res.render('mycareer');        else{         var dt = moment(dates.vcdate,"YYYY-MM-DD").year();        //var dt=2016;         var current_date=moment().year();         if(dt==current_date){          res.render('mycareer',{dates:dates});         }         else{         res.render('mycareer',{notstarted:'appraisal not at satrted'});          }        }            });    }    else{      var aec,aect,ace,hodsdata;      var data={        Role:'staff',        PrincipalReview:'false',        AppraisalYear:current_date      }            appraisal.getAecStaffAppraisalsForVc(data,function(err,aecfac){          if(err)            console.log(err);          else{             aec=aecfac;           // console.log(aec);            appraisal.getAectStaffAppraisalsForVc(data,function(err,aectfac){            if(err)              console.log(err);            else{              acet=aectfac;              appraisal.getAceStaffAppraisalsForVc(data,function(err,acefac){                if(err)                  console.log(err);                else{                  ace=acefac;                  console.log({aec:aec,acet:acet,ace:ace});                                    datahod={                     Role:'HOD',                     PrincipalReview:'false',                     AppraisalYear:current_date };                                    appraisal.getAecHodAppraisalsForVc(datahod,function(err,aechods){                    if (err)                      console.log(err);                    else{                       // console.log(hodsdata);                        appraisal.getAcetHodAppraisalsForVc(datahod,function(err,acethods){                          if(err)                            console.log(err);                          else{                           // hodsdata +=acethods;                            appraisal.getAceHodAppraisalsForVc(datahod,function(err,acehods){                              if(err)                                console.log(err);                              else{                                hodsdata={aec:aechods,acet:acethods,ace:acehods};                                                            console.log(hodsdata);                              res.render('vcpannel',{aec:aec,acet:acet,ace:ace,hodsdata:hodsdata});                            }                            });                          }                        });                    }                  });                                  }              });            }          });      }    });           }  }  else    res.redirect('login');});router.post('/reviewdate',function(req,res){ var vc_date=req.body.date; var principal_dates=moment(vc_date,"YYYY/MM/DD"); principal_dates.subtract(5,'days'); var principal_date=moment(principal_dates).format('YYYY/MM/DD'); var hod_dates=moment(principal_date,"YYYY/MM/DD"); hod_dates.subtract(5,'days'); var hod_date=moment(hod_dates).format('YYYY/MM/DD'); var faculty_dates=moment(hod_date,"YYYY/MM/DD"); faculty_dates.subtract(5,'days'); var faculty_date=moment(faculty_dates).format('YYYY/MM/DD');  var dt=moment().year(); res.send({vc:vc_date,pc:principal_date,hod:hod_date,fac:faculty_date,current:dt}); reviewDate.setReviewDate(vc_date,principal_date,hod_date,faculty_date,function(err,user){  console.log(err);});});router.post('/upload/:pr', function(req, res){  // create an incoming form object  var form = new formidable.IncomingForm();  // specify that we want to allow the user to upload multiple files in a single request  form.multiples = true;  // store all uploads in the /uploads directory    var db=req.db;  var stinfo =db.get('staffinfo');      if(req.params.pr== 1)    form.uploadDir = path.join(__dirname,'../public/uploads/bank');  else if(req.params.pr== 2)    form.uploadDir = path.join(__dirname,'../public/uploads/adhar');  else if(req.params.pr== 3)    form.uploadDir = path.join(__dirname,'../public/uploads/passport');  else if(req.params.pr== 4)    form.uploadDir = path.join(__dirname,'../public/uploads/ssc');  else if(req.params.pr== 5)    form.uploadDir = path.join(__dirname,'../public/uploads/inter');  else if(req.params.pr== 6)    form.uploadDir = path.join(__dirname,'../public/uploads/ug');  else if(req.params.pr== 7)    form.uploadDir = path.join(__dirname,'../public/uploads/pg');  // every time a file has been uploaded successfully,  // rename it to it's orignal name  form.on('file', function(field, file) {    var fileType = file.name.split('.').pop();    var name=req.session.user._id+'.'+fileType;    fs.rename(file.path, path.join(form.uploadDir,name));    if(req.params.pr== 1){      var bank={"bank":"uploads/bank/"+name};      staffInfo.updateFile(req.session.user.PinNo,bank,function(err){        console.log(err);      });       }    else if(req.params.pr== 2){      var adhar={"adhar":"uploads/adhar/"+name};      staffInfo.updateFile(req.session.user.PinNo,adhar,function(err){        console.log(err);      });    }         else if(req.params.pr== 3){       var passport={"passport":"uploads/passport/"+name};      staffInfo.updateFile(req.session.user.PinNo,passport,function(err){        console.log(err);      });    }     else if(req.params.pr== 4){       var ssc={"SSC.Certificate":"uploads/ssc/"+name};      staffInfo.updateFile(req.session.user.PinNo,ssc,function(err){        console.log(err);      });    }    else if(req.params.pr== 5){       var ssc={"Inter.Certificate":"uploads/inter/"+name};      staffInfo.updateFile(req.session.user.PinNo,ssc,function(err){        console.log(err);      });    }    else if(req.params.pr== 6){       var ssc={"UG.Certificate":"uploads/ug/"+name};      staffInfo.updateFile(req.session.user.PinNo,ssc,function(err){        console.log(err);      });    }    else if(req.params.pr== 7){       var ssc={"PG.Certificate":"uploads/pg/"+name};      staffInfo.updateFile(req.session.user.PinNo,ssc,function(err){        console.log(err);      });    }});      // log any errors that occur  form.on('error', function(err) {    console.log('An error has occured: \n' + err);  });  // once all the files have been uploaded, send a response to the client  form.on('end', function() {    res.end('success');  });  // parse the incoming request containing the form data  form.parse(req);});module.exports = router;